
<!DOCTYPE html>
<html lang="tl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card-shadow {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .module-card {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      transition: all 0.3s ease;
    }
    .module-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    .module-card.completed {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .module-card.locked {
      background: linear-gradient(135deg, #e2e2e2 0%, #c9c9c9 100%);
      opacity: 0.6;
    }
    .progress-ring {
      transform: rotate(-90deg);
    }
    .progress-ring-fill {
      transition: stroke-dashoffset 0.35s;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-white to-blue-50 min-h-screen">
  <!-- Header -->
  <header class="gradient-bg shadow-2xl">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-4">
          <div class="w-12 h-12 bg-white bg-opacity-20 backdrop-blur-lg rounded-xl flex items-center justify-center">
            <span class="text-2xl">üéì</span>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-white">Learning Dashboard</h1>
            <p class="text-purple-100 text-sm" id="studentName">Welcome back!</p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-white text-right">
            <p class="text-sm opacity-75">Section</p>
            <p class="font-semibold" id="studentSection">-</p>
          </div>
          <div class="text-white text-right">
            <p class="text-sm opacity-75">Adviser</p>
            <p class="font-semibold" id="studentAdviser">-</p>
          </div>
          <div class="text-white text-right">
            <p class="text-sm opacity-75">LRN</p>
            <p class="font-semibold" id="studentLRN">-</p>
          </div>
          <a href="login.html" class="bg-white bg-opacity-20 backdrop-blur-lg hover:bg-opacity-30 text-white px-6 py-2 rounded-xl font-medium transition-all duration-200 border border-white border-opacity-20">
            Logout
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-2xl p-6 card-shadow">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
            <span class="text-2xl">üìö</span>
          </div>
          <div class="ml-4">
            <p class="text-sm text-gray-600">Total Modules</p>
            <p class="text-2xl font-bold text-gray-900" id="totalModules">0</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-2xl p-6 card-shadow">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
            <span class="text-2xl">‚úÖ</span>
          </div>
          <div class="ml-4">
            <p class="text-sm text-gray-600">Completed</p>
            <p class="text-2xl font-bold text-gray-900" id="completedModules">0</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-2xl p-6 card-shadow">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
            <span class="text-2xl">üìä</span>
          </div>
          <div class="ml-4">
            <p class="text-sm text-gray-600">Progress</p>
            <p class="text-2xl font-bold text-gray-900" id="progressPercentage">0%</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-2xl p-6 card-shadow">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
            <span class="text-2xl">üèÜ</span>
          </div>
          <div class="ml-4">
            <p class="text-sm text-gray-600">Avg. Score</p>
            <p class="text-2xl font-bold text-gray-900" id="averageScore">0%</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modules Section -->
    <div class="bg-white rounded-2xl card-shadow overflow-hidden">
      <div class="px-8 py-6 bg-gradient-to-r from-blue-50 to-purple-50 border-b border-gray-100">
        <h2 class="text-2xl font-bold text-gray-900">üìñ Your Learning Modules</h2>
        <p class="text-gray-600 mt-1">Complete modules to unlock the next ones</p>
      </div>
      <div class="p-8">
        <div id="modulesContainer" class="space-y-8">
          <!-- Modules will be loaded here -->
        </div>
      </div>
    </div>
  </main>
  <script>
    const lrn = localStorage.getItem("studentLRN");
    if (!lrn) {
      alert("Missing student LRN. Please log in again.");
      window.location.href = "login.html";
    }

    async function loadDashboard() {
      try {
        // Use relative API path
        const res = await fetch(`../api/student-modules.php?lrn=${lrn}`);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        
        if (!data.success) {
          alert(data.message || "Failed to load data.");
          return;
        }
        
        const student = data.data.student;
        const modules = data.data.modules;
        const adviser = data.data.adviser;
        
        if (!student) {
          alert("Student not found.");
          return;
        }

        // Update student information in header
        document.getElementById("studentName").textContent = `Welcome back, ${student.firstName}!`;
        document.getElementById("studentLRN").textContent = lrn;
        document.getElementById("studentSection").textContent = student.section || '-';
        document.getElementById("studentAdviser").textContent = adviser ? adviser.name : '-';

        // Parse progress
        let progress = {};
        if (typeof student.progress === 'string') {
          try {
            progress = JSON.parse(student.progress);
          } catch (e) {
            progress = {};
          }
        } else {
          progress = student.progress || {};
        }

        // Calculate statistics
        const totalModules = modules.length;
        let completedModules = 0;
        let totalScore = 0;
        let scoredModules = 0;

        modules.forEach(mod => {
          const moduleKey = `module${mod.id}`;
          const moduleProgress = progress[moduleKey];
          if (moduleProgress?.passed === true) {
            completedModules++;
          }
          if (moduleProgress?.score) {
            totalScore += (moduleProgress.score / mod.questions.length) * 100;
            scoredModules++;
          }
        });

        const progressPercentage = totalModules > 0 ? Math.round((completedModules / totalModules) * 100) : 0;
        const averageScore = scoredModules > 0 ? Math.round(totalScore / scoredModules) : 0;

        // Update stats
        document.getElementById("totalModules").textContent = totalModules;
        document.getElementById("completedModules").textContent = completedModules;
        document.getElementById("progressPercentage").textContent = progressPercentage + "%";
        document.getElementById("averageScore").textContent = averageScore + "%";

        // Render modules grouped by subject and quarter
        const container = document.getElementById("modulesContainer");
        container.innerHTML = "";
        
        // Group modules by subject and quarter
        const modulesBySubject = {};
        modules.forEach(mod => {
          const subject = mod.subject || 'General';
          if (!modulesBySubject[subject]) {
            modulesBySubject[subject] = {};
          }
          const quarter = mod.quarter || 'Q1';
          if (!modulesBySubject[subject][quarter]) {
            modulesBySubject[subject][quarter] = [];
          }
          modulesBySubject[subject][quarter].push(mod);
        });

        let unlocked = true;
        const subjectColors = {
          'FILIPINO': 'from-yellow-500 to-orange-600',
          'ENGLISH': 'from-red-500 to-pink-600',
          'MATH': 'from-blue-500 to-purple-600',
          'SCIENCE': 'from-green-500 to-teal-600',
          'ARALING PANLIPUNAN': 'from-amber-500 to-red-600',
          'EDUKASYON SA PAGPAPAKATAO': 'from-purple-500 to-indigo-600',
          'TECHNOLOGY AND LIVELIHOOD': 'from-cyan-500 to-blue-600',
          'MAPEH': 'from-pink-500 to-rose-600',
          'RESEARCH (For Science Section Only)': 'from-slate-500 to-gray-600',
          // Legacy mappings for backward compatibility
          'Filipino': 'from-yellow-500 to-orange-600',
          'English': 'from-red-500 to-pink-600',
          'Mathematics': 'from-blue-500 to-purple-600',
          'Math': 'from-blue-500 to-purple-600',
          'Science': 'from-green-500 to-teal-600',
          'Social Studies': 'from-amber-500 to-red-600',
          'General': 'from-gray-500 to-slate-600'
        };

        // Define subject order
        const subjectOrder = [
          'FILIPINO',
          'ENGLISH', 
          'MATH',
          'SCIENCE',
          'ARALING PANLIPUNAN',
          'EDUKASYON SA PAGPAPAKATAO',
          'TECHNOLOGY AND LIVELIHOOD',
          'MAPEH',
          'RESEARCH (For Science Section Only)'
        ];

        // Sort subjects according to the specified order
        const sortedSubjects = Object.keys(modulesBySubject).sort((a, b) => {
          const indexA = subjectOrder.indexOf(a.toUpperCase());
          const indexB = subjectOrder.indexOf(b.toUpperCase());
          
          // If both subjects are in the order list, sort by their position
          if (indexA !== -1 && indexB !== -1) {
            return indexA - indexB;
          }
          // If only one is in the order list, it comes first
          if (indexA !== -1) return -1;
          if (indexB !== -1) return 1;
          // If neither is in the order list, sort alphabetically
          return a.localeCompare(b);
        });

        sortedSubjects.forEach(subject => {
          const subjectData = modulesBySubject[subject];
          const subjectColor = subjectColors[subject] || subjectColors['General'];
          
          // Subject section
          const subjectSection = document.createElement("div");
          subjectSection.className = "mb-12";
          
          // Subject header with gradient background
          const subjectHeader = document.createElement("div");
          subjectHeader.className = `bg-gradient-to-r ${subjectColor} rounded-2xl p-6 mb-6 shadow-xl`;
          subjectHeader.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-2xl font-bold text-white mb-2">üìö ${subject}</h2>
                <p class="text-white/80">Organized by quarter for better learning progression</p>
              </div>
              <div class="text-4xl opacity-20">üéØ</div>
            </div>
          `;
          subjectSection.appendChild(subjectHeader);

          // Quarters within this subject
          const quarters = ["Q1", "Q2", "Q3", "Q4"];
          quarters.forEach(quarter => {
            const quarterModules = subjectData[quarter] || [];
            
            if (quarterModules.length === 0) return;

            // Quarter subsection
            const quarterDiv = document.createElement("div");
            quarterDiv.className = "mb-8";
            
            // Quarter header with modern design
            const quarterHeader = document.createElement("div");
            quarterHeader.className = "flex items-center gap-3 mb-4 pl-4";
            quarterHeader.innerHTML = `
              <div class="w-12 h-12 bg-gradient-to-br ${subjectColor} rounded-xl flex items-center justify-center text-white font-bold shadow-lg">
                ${quarter}
              </div>
              <div>
                <h3 class="text-xl font-bold text-gray-800">${quarter} Modules</h3>
                <p class="text-gray-600 text-sm">${quarterModules.length} module(s) available</p>
              </div>
            `;
            quarterDiv.appendChild(quarterHeader);

            // Modules grid with enhanced design
            const modulesGrid = document.createElement("div");
            modulesGrid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pl-4";
            
            quarterModules.forEach(mod => {
              const moduleKey = `module${mod.id}`;
              const moduleProgress = progress[moduleKey];
              const score = moduleProgress?.score || 0;
              const passed = moduleProgress?.passed;
              const isCompleted = passed === true;
              const isAttempted = score > 0;

              const card = document.createElement("div");
              
              // Enhanced card styling with glassmorphism effect
              let cardClass = "relative overflow-hidden rounded-2xl p-6 text-white transform transition-all duration-300 hover:scale-105 hover:shadow-2xl";
              let statusIcon = "ÔøΩ";
              let statusText = "Start Learning";
              let gradientClass = `bg-gradient-to-br ${subjectColor}`;
              let borderClass = "border border-white/20";

              if (!unlocked) {
                gradientClass = "bg-gradient-to-br from-gray-400 to-gray-600";
                statusIcon = "üîí";
                statusText = "Locked";
                cardClass += " opacity-60 cursor-not-allowed hover:scale-100";
              } else if (isCompleted) {
                gradientClass = "bg-gradient-to-br from-emerald-500 to-teal-600";
                statusIcon = "‚ú®";
                statusText = "Completed";
                borderClass = "border border-emerald-300/30";
              } else if (isAttempted) {
                gradientClass = "bg-gradient-to-br from-amber-500 to-orange-600";
                statusIcon = "‚ö°";
                statusText = "Continue";
                borderClass = "border border-amber-300/30";
              }

              card.className = `${cardClass} ${gradientClass} ${borderClass}`;
              
              // Score percentage for completed/attempted modules
              const scorePercentage = mod.questions.length > 0 ? Math.round((score / mod.questions.length) * 100) : 0;

              card.innerHTML = `
                <!-- Decorative background pattern -->
                <div class="absolute inset-0 opacity-10">
                  <div class="absolute top-0 right-0 w-32 h-32 rounded-full bg-white transform translate-x-16 -translate-y-16"></div>
                  <div class="absolute bottom-0 left-0 w-24 h-24 rounded-full bg-white transform -translate-x-12 translate-y-12"></div>
                </div>
                
                <!-- Status badge -->
                <div class="absolute top-4 right-4 w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-xl border border-white/30">
                  ${statusIcon}
                </div>
                
                <!-- Module content -->
                <div class="relative z-10">
                  <div class="mb-6">
                    <h4 class="text-xl font-bold mb-3 leading-tight">${mod.title || `Module ${mod.id}`}</h4>
                    <div class="flex items-center gap-2 mb-2">
                      <div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center">
                        <span class="text-xs">üë®‚Äçüè´</span>
                      </div>
                      <p class="text-sm text-white/90">${mod.teacher_name}</p>
                    </div>
                    ${isAttempted ? `
                      <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center">
                          <span class="text-xs">üìä</span>
                        </div>
                        <p class="text-sm text-white/90">Score: ${scorePercentage}%</p>
                      </div>
                    ` : ''}
                  </div>
                  
                  <!-- Action button -->
                  <div class="mt-auto">
                    ${unlocked ? 
                      `<a href='module-viewer.html?id=${mod.id}' class='w-full bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 inline-block text-center border border-white/30 hover:border-white/50 shadow-lg'>
                        <span class="flex items-center justify-center gap-2">
                          <span>${statusIcon}</span>
                          <span>${statusText}</span>
                        </span>
                      </a>` :
                      `<button disabled class='w-full bg-gray-500/50 text-white/60 px-6 py-3 rounded-xl font-semibold inline-block text-center border border-gray-400/30 cursor-not-allowed'>
                        <span class="flex items-center justify-center gap-2">
                          <span>${statusIcon}</span>
                          <span>${statusText}</span>
                        </span>
                      </button>`
                    }
                  </div>
                </div>
              `;

              modulesGrid.appendChild(card);

              // Update unlocked status for next module
              if (moduleProgress && passed !== true) unlocked = false;
            });

            quarterDiv.appendChild(modulesGrid);
            subjectSection.appendChild(quarterDiv);
          });

          container.appendChild(subjectSection);
        });

        // Show message if no modules
        if (modules.length === 0) {
          container.innerHTML = `
            <div class="text-center py-12">
              <div class="text-6xl mb-4">üìö</div>
              <h3 class="text-xl font-semibold text-gray-800 mb-2">No modules available yet</h3>
              <p class="text-gray-600">Your teachers haven't assigned any modules yet. Check back later!</p>
            </div>
          `;
        }

      } catch (error) {
        console.error("Dashboard loading error:", error);
        alert("Error loading dashboard. Check console for details.");
      }
    }

    loadDashboard();
  </script>
</body>
</html>
