
<!DOCTYPE html>
<html lang="tl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard - Student Progress Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    .hover-lift { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    .status-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .status-complete { background-color: #dcfce7; color: #166534; }
    .status-pending { background-color: #fef2f2; color: #dc2626; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; }
    .table-row:hover { background-color: #f8fafc; }
    .module-card { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0ea5e9; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="gradient-bg shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-6">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
            <span class="text-2xl">📚</span>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-white">Teacher's Dashboard</h1>
            <p class="text-blue-100 text-sm">Welcome, <span id="teacherName">Teacher</span></p>
          </div>
        </div>
        <button class="logout-btn bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2" onclick="logout()">
          <span>🚪</span>
          <span>Log Out</span>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-xl card-shadow p-6 hover-lift">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
            <span class="text-2xl">👥</span>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Total Students</p>
            <p class="text-2xl font-bold text-gray-900" id="totalStudents">0</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl card-shadow p-6 hover-lift">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
            <span class="text-2xl">✅</span>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Completed</p>
            <p class="text-2xl font-bold text-green-600" id="completedCount">0</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl card-shadow p-6 hover-lift">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
            <span class="text-2xl">📝</span>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Active Modules</p>
            <p class="text-2xl font-bold text-orange-600" id="moduleCount">0</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Assigned Teachers Section (Only for Advisers) -->
    <div id="assignedTeachersSection" class="bg-white rounded-xl card-shadow p-6 mb-8" style="display: none;">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-gray-900 flex items-center space-x-2">
          <span>👥</span>
          <span>Subject Teachers Assigned to Your Advisory Section</span>
        </h2>
        <button onclick="refreshAssignedTeachers()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
          <span>🔄</span>
          <span>Refresh</span>
        </button>
      </div>
      
      <div id="advisoryInfo" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
        <h4 class="font-medium text-blue-800 mb-1">Advisory Section</h4>
        <p id="currentAdvisorySection" class="text-blue-700">-</p>
      </div>
      
      <div id="assignedTeachersList" class="space-y-3">
        <!-- Assigned teachers will be loaded here -->
      </div>
    </div>

    <!-- Controls Section -->
    <div class="bg-white rounded-xl card-shadow p-6 mb-8">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
        <div class="relative flex-1 max-w-md">
          <svg class="search-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input 
            type="text" 
            id="searchInput" 
            placeholder="Search by name, section, or LRN..." 
            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
          >
        </div>
        <div class="flex flex-wrap gap-3">
          <a href="teacher-module-creator.html" class="btn-create-module bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2 hover-lift">
            <span>➕</span>
            <span>Create New Module</span>
          </a>
          <button onclick="openSectionManagement()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2 hover-lift">
            <span>🏫</span>
            <span>Assign Subject Teachers</span>
          </button>
          <button onclick="openSectionsTaughtManagement()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2 hover-lift">
            <span>📚</span>
            <span>Manage Sections Taught</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Section Management Modal -->
    <div id="sectionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-900 flex items-center space-x-2">
              <span>🏫</span>
              <span>Assign Subject Teachers</span>
            </h3>
            <button onclick="closeSectionManagement()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
          </div>
          
          <!-- Teacher Info -->
          <div id="teacherSectionInfo" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h4 class="font-semibold text-blue-800 mb-2">📋 Your Advisory Section</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div><strong>Name:</strong> <span id="profileName">-</span></div>
              <div><strong>Subject:</strong> <span id="profileSubject">-</span></div>
              <div><strong>Advisory Section:</strong> <span id="profileAdvisorySection">-</span></div>
            </div>
            <div class="mt-2">
              <strong>Sections Taught:</strong> <span id="profileSections">-</span>
            </div>
          </div>
          
          <!-- Subject Teacher Assignment Section -->
          <div class="bg-white border rounded-lg p-6">
            <h4 class="font-semibold text-gray-800 mb-4 flex items-center space-x-2">
              <span>�‍🏫</span>
              <span>Available Teachers for Assignment</span>
            </h4>
            
            <!-- Filters -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
              <h5 class="font-medium text-gray-700 mb-3">🔍 Filter Teachers</h5>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">Grade Level</label>
                  <select id="filterGrade" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterTeachers()">
                    <option value="">All Grades</option>
                    <option value="7">Grade 7</option>
                    <option value="8">Grade 8</option>
                    <option value="9">Grade 9</option>
                    <option value="10">Grade 10</option>
                    <option value="11">Grade 11</option>
                    <option value="12">Grade 12</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">Subject</label>
                  <select id="filterSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterTeachers()">
                    <option value="">All Subjects</option>
                    <option value="Mathematics">Mathematics</option>
                    <option value="Science">Science</option>
                    <option value="English">English</option>
                    <option value="Filipino">Filipino</option>
                    <option value="Araling Panlipunan">Araling Panlipunan</option>
                    <option value="MAPEH">MAPEH</option>
                    <option value="ESP">ESP</option>
                    <option value="TLE">TLE</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">Search Name</label>
                  <input type="text" id="filterName" placeholder="Type teacher name..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" oninput="filterTeachers()">
                </div>
              </div>
              <div class="mt-3 flex justify-between items-center">
                <button onclick="clearFilters()" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Clear All Filters</button>
                <span id="teacherCount" class="text-sm text-gray-500">0 teachers found</span>
              </div>
            </div>

            <!-- Teachers List -->
            <div id="teachersList" class="space-y-3 max-h-96 overflow-y-auto">
              <!-- Teachers will be populated here -->
            </div>
          </div>
          
          <!-- Subject Teacher Assignments (Only for Advisers) -->
          <div id="subjectTeacherSection" class="bg-white border rounded-lg p-4">
            <h4 class="font-semibold text-gray-800 mb-4 flex items-center space-x-2">
              <span>�‍🏫</span>
              <span>Assign Subject Teachers (Adviser Only)</span>
            </h4>
            <div id="adviserSectionsList" class="space-y-4">
              <!-- Will be populated for adviser sections -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sections Taught Management Modal -->
    <div id="sectionsTaughtModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-900 flex items-center space-x-2">
              <span>📚</span>
              <span>Manage Sections Taught</span>
            </h3>
            <button onclick="closeSectionsTaughtManagement()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
          </div>

          <!-- Current Sections List -->
          <div class="mb-6">
            <h4 class="font-semibold text-gray-800 mb-3">Current Sections Taught</h4>
            <div id="currentSectionsList" class="space-y-2 min-h-[100px] p-4 border border-gray-200 rounded-lg bg-gray-50">
              <!-- Will be populated with current sections -->
            </div>
          </div>

          <!-- Add New Section -->
          <div class="border-t pt-6">
            <h4 class="font-semibold text-gray-800 mb-3">Add New Section</h4>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Grade Level</label>
                <select id="sectionGradeLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                  <option value="">Loading grade levels...</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Available Sections</label>
                <select id="availableSections" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                  <option value="">Select grade level first</option>
                </select>
              </div>
            </div>
            <button onclick="addNewSection()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
              Add Selected Section
            </button>
            <p class="text-sm text-gray-500 mt-2">These sections will be available when creating modules</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Students Table -->
    <div class="bg-white rounded-xl card-shadow overflow-hidden mb-8">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0 mb-4">
          <h2 class="text-xl font-semibold text-gray-900 flex items-center space-x-2">
            <span>👨‍🎓</span>
            <span>Student Progress Overview</span>
          </h2>
          <div class="flex items-center space-x-2">
            <span id="studentCountDisplay" class="text-sm text-gray-500">0 students</span>
          </div>
        </div>
        
        <!-- Filters Section -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h4 class="font-medium text-gray-700 mb-3 flex items-center space-x-2">
            <span>🔍</span>
            <span>Filter & Sort Students</span>
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">Grade Level</label>
              <select id="filterStudentGrade" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" onchange="filterStudents()">
                <option value="">All Grades</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">Section</label>
              <select id="filterStudentSection" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" onchange="filterStudents()">
                <option value="">All Sections</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">Sort By</label>
              <select id="sortStudentsBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" onchange="filterStudents()">
                <option value="name">Name (A-Z)</option>
                <option value="name_desc">Name (Z-A)</option>
                <option value="grade">Grade Level</option>
                <option value="section">Section</option>
                <option value="progress">Progress</option>
              </select>
            </div>
            <div class="flex items-end">
              <button onclick="clearStudentFilters()" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                Clear Filters
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full" id="studentsTable">
          <thead class="bg-gray-50" id="studentsTableHead">
            <!-- Dynamic columns will be rendered here -->
          </thead>
          <tbody id="studentTableBody" class="bg-white divide-y divide-gray-200">
            <!-- Dynamic student rows will be rendered here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modules Section -->
    <div class="bg-white rounded-xl card-shadow p-6">
      <div class="flex items-center space-x-3 mb-6">
        <span class="text-2xl">🗂️</span>
        <h2 class="text-xl font-semibold text-gray-900">Created Modules</h2>
      </div>
      <div id="moduleList" class="space-y-4"></div>
    </div>
  </main>

  <script>
    const tableBody = document.getElementById("studentTableBody");
    const tableHead = document.getElementById("studentsTableHead");
    const searchInput = document.getElementById("searchInput");
    let students = [];
    let filteredStudents = [];
    let modules = [];

    function updateStats() {
      document.getElementById('totalStudents').textContent = students.length;
      let completed = 0;
      students.forEach(s => {
        let allPassed = true;
        modules.forEach(mod => {
          const key = `module${mod.id}`;
          const progress = s.progress?.[key];
          if (!progress?.passed) allPassed = false;
        });
        if (allPassed && modules.length) completed++;
      });
      document.getElementById('completedCount').textContent = completed;
      document.getElementById('moduleCount').textContent = modules.length;
    }

    async function fetchStudents() {
      try {
        const res = await fetch('/tms/remediation-web/api/students.php');
        const data = await res.json();
        if (Array.isArray(data)) {
          students = data;
        } else if (data.success && Array.isArray(data.data)) {
          students = data.data;
        } else {
          students = [];
          if (data.error) {
            alert('Error loading students: ' + data.error);
          }
        }
        
        // Initialize filtered students and populate filter dropdowns
        filteredStudents = [...students];
        populateStudentFilters();
        renderTable();
        updateStats();
      } catch (error) {
        students = [];
        alert('Failed to load students. Please check your login status.');
      }
    }

    async function loadModules() {
      try {
        const res = await fetch("/tms/remediation-web/api/modules.php");
        const data = await res.json();
        if (Array.isArray(data)) {
          modules = data;
        } else if (data.success && Array.isArray(data.data)) {
          modules = data.data;
        } else {
          modules = [];
        }
        
        renderTable();
        renderModules();
        updateStats();
      } catch (error) {
        modules = [];
      }
    }

    function renderTable() {
      // Ensure students and modules are arrays
      if (!Array.isArray(students)) {
        students = [];
      }
      if (!Array.isArray(modules)) {
        modules = [];
      }
      
      // Render table head
      let headHtml = `<tr>
        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Name</th>
        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">First Name</th>
        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade & Section</th>
        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">LRN</th>`;
      modules.forEach(mod => {
        headHtml += `<th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${mod.title || `Module ${mod.id}`}</th>`;
      });
      headHtml += `<th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr>`;
      tableHead.innerHTML = headHtml;

      // Render table body
      let bodyHtml = "";
      let displayedCount = 0;
      filteredStudents.forEach(student => {
        const searchTarget = `${student.lastName} ${student.firstName} ${student.section} ${student.lrn}`.toLowerCase();
        if (searchInput.value && !searchTarget.includes(searchInput.value.toLowerCase())) return;
        displayedCount++;
        bodyHtml += `<tr class="table-row transition-colors duration-150">
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.lastName}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.firstName}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.section}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.lrn}</td>`;
        modules.forEach(mod => {
          const key = `module${mod.id}`;
          const progress = student.progress?.[key];
          const passed = progress?.passed;
          const score = typeof progress === "object" && "score" in progress ? progress.score : (typeof progress === "number" ? progress : null);
          bodyHtml += `<td class="px-6 py-4 whitespace-nowrap">
            <span class="status-badge ${passed ? 'status-complete' : 'status-pending'}">
              ${passed ? `✅ Complete<br><span class='text-xs text-gray-700'>Score: ${score ?? '-'}</span>` : '⏳ Pending'}
            </span>
          </td>`;
        });
        bodyHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
          <button class="text-blue-600 hover:text-blue-900 mr-3 transition-colors duration-150" onclick="viewStudent('${student.lrn}')">View</button>
          <button class="reset-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs transition-colors duration-150" onclick="resetProgress(${student.id})">Reset</button>
        </td></tr>`;
      });
      tableBody.innerHTML = bodyHtml;
      
      // Update student count display
      document.getElementById('studentCountDisplay').textContent = `${displayedCount} students`;
    }

    function populateStudentFilters() {
      const gradeFilter = document.getElementById('filterStudentGrade');
      const sectionFilter = document.getElementById('filterStudentSection');
      
      // Get unique grades and sections from students
      const uniqueGrades = [...new Set(students.map(s => s.grade || s.section?.split('-')[0]).filter(Boolean))].sort();
      const uniqueSections = [...new Set(students.map(s => s.section).filter(Boolean))].sort();
      
      // Populate grade filter
      gradeFilter.innerHTML = '<option value="">All Grades</option>';
      uniqueGrades.forEach(grade => {
        const option = document.createElement('option');
        option.value = grade;
        option.textContent = `Grade ${grade}`;
        gradeFilter.appendChild(option);
      });
      
      // Populate section filter
      sectionFilter.innerHTML = '<option value="">All Sections</option>';
      uniqueSections.forEach(section => {
        const option = document.createElement('option');
        option.value = section;
        option.textContent = section;
        sectionFilter.appendChild(option);
      });
    }

    function filterStudents() {
      const gradeFilter = document.getElementById('filterStudentGrade').value;
      const sectionFilter = document.getElementById('filterStudentSection').value;
      const sortBy = document.getElementById('sortStudentsBy').value;
      
      // Filter students
      filteredStudents = students.filter(student => {
        const studentGrade = student.grade || student.section?.split('-')[0];
        const matchesGrade = !gradeFilter || studentGrade === gradeFilter;
        const matchesSection = !sectionFilter || student.section === sectionFilter;
        
        return matchesGrade && matchesSection;
      });
      
      // Sort students
      sortStudents(sortBy);
      
      // Re-render table
      renderTable();
    }

    function sortStudents(sortBy) {
      switch (sortBy) {
        case 'name':
          filteredStudents.sort((a, b) => {
            const nameA = `${a.lastName} ${a.firstName}`.toLowerCase();
            const nameB = `${b.lastName} ${b.firstName}`.toLowerCase();
            return nameA.localeCompare(nameB);
          });
          break;
        case 'name_desc':
          filteredStudents.sort((a, b) => {
            const nameA = `${a.lastName} ${a.firstName}`.toLowerCase();
            const nameB = `${b.lastName} ${b.firstName}`.toLowerCase();
            return nameB.localeCompare(nameA);
          });
          break;
        case 'grade':
          filteredStudents.sort((a, b) => {
            const gradeA = parseInt(a.grade || a.section?.split('-')[0] || '0');
            const gradeB = parseInt(b.grade || b.section?.split('-')[0] || '0');
            return gradeA - gradeB;
          });
          break;
        case 'section':
          filteredStudents.sort((a, b) => (a.section || '').localeCompare(b.section || ''));
          break;
        case 'progress':
          filteredStudents.sort((a, b) => {
            // Calculate progress percentage for each student
            const progressA = calculateStudentProgress(a);
            const progressB = calculateStudentProgress(b);
            return progressB - progressA; // Higher progress first
          });
          break;
        default:
          // Default to name sorting
          filteredStudents.sort((a, b) => {
            const nameA = `${a.lastName} ${a.firstName}`.toLowerCase();
            const nameB = `${b.lastName} ${b.firstName}`.toLowerCase();
            return nameA.localeCompare(nameB);
          });
      }
    }

    function calculateStudentProgress(student) {
      if (!modules.length) return 0;
      
      let completedModules = 0;
      modules.forEach(mod => {
        const key = `module${mod.id}`;
        const progress = student.progress?.[key];
        if (progress?.passed) completedModules++;
      });
      
      return (completedModules / modules.length) * 100;
    }

    function clearStudentFilters() {
      document.getElementById('filterStudentGrade').value = '';
      document.getElementById('filterStudentSection').value = '';
      document.getElementById('sortStudentsBy').value = 'name';
      filteredStudents = [...students];
      renderTable();
    }

    function renderModules() {
      if (!modules.length) return;
      const moduleList = document.getElementById('moduleList');
      moduleList.innerHTML = modules.map(mod => `
        <div class="module-card p-4 rounded-lg hover-lift transition-all duration-200">
          <div class="flex justify-between items-center">
            <div class="flex-1">
              <h3 class="font-semibold text-gray-900 mb-1">${mod.title || mod.filename}</h3>
              <p class="text-sm text-gray-600">${mod.quarter ? `Quarter: ${mod.quarter}` : ''}</p>
              <div class="flex items-center space-x-4 mt-2">
                <span class="text-xs text-gray-500">📅 Created: ${mod.created_at ? mod.created_at.split('T')[0] : ''}</span>
              </div>
            </div>
            <div class="flex space-x-2 ml-4">
              <button class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-150 flex items-center space-x-1" onclick="editModule(${mod.id})">
                <span>✏️</span>
                <span>Edit</span>
              </button>
              <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-150 flex items-center space-x-1" onclick="deleteModule(${mod.id})">
                <span>🗑️</span>
                <span>Delete</span>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    searchInput.addEventListener('input', renderTable);

    function logout() {
      localStorage.removeItem("teacherLoggedIn");
      localStorage.removeItem("teacherToken");
      localStorage.removeItem("teacherUser");
      window.location.href = "teacher-login.html";
    }

    function viewStudent(lrn) {
      alert('View details for student LRN: ' + lrn);
      // Implement modal or redirect for detailed view if needed
    }

    async function resetProgress(id) {
      await fetch('/tms/remediation-web/api/reset-progress.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      });
      fetchStudents();
    }

    function editModule(id) {
      window.location.href = `edit-module.html?id=${id}`;
    }

    async function deleteModule(id) {
      if (!confirm("Are you sure you want to delete this module?")) return;
      const res = await fetch(`/api/delete-module/${id}`, { method: "DELETE" });
      const data = await res.json();
      if (data.success) {
        alert("✅ Module deleted.");
        loadModules();
      } else {
        alert("❌ Delete failed.");
      }
    }

    // New Modal Functions for Teacher Assignment
    let allTeachers = [];
    let filteredTeachers = [];

    async function loadAvailableTeachers() {
      try {
        const teacher = checkTeacherAuth();
        if (!teacher) return;
        
        // Get assigned teacher IDs to exclude them
        const assignedTeacherIds = assignedTeachers.map(t => t.id);
        
        // Exclude current teacher from the list
        const response = await fetch(`/tms/remediation-web/api/get-teachers.php?exclude_teacher_id=${teacher.id}`);
        const data = await response.json();
        
        if (data.success && data.data) {
          // Filter out already assigned teachers
          allTeachers = data.data.filter(t => !assignedTeacherIds.includes(t.id));
          filteredTeachers = [...allTeachers];
          renderTeacherList();
          
          // Update teacher count
          document.getElementById('teacherCount').textContent = `${allTeachers.length} teachers found`;
        } else {
          document.getElementById('teachersList').innerHTML = `<p class="text-red-500">Error loading teachers: ${data.message || 'Unknown error'}</p>`;
        }
      } catch (error) {
        document.getElementById('teachersList').innerHTML = '<p class="text-red-500">Error loading teachers. Please try again.</p>';
      }
    }

    function renderTeacherList() {
      const teacherList = document.getElementById('teachersList'); // Fixed: was 'teacherList', now 'teachersList'
      
      if (filteredTeachers.length === 0) {
        teacherList.innerHTML = '<p class="text-gray-500 text-center py-4">No teachers found matching the current filters.</p>';
        document.getElementById('teacherCount').textContent = '0 teachers found';
        return;
      }

      // Update count
      document.getElementById('teacherCount').textContent = `${filteredTeachers.length} teachers found`;

      teacherList.innerHTML = filteredTeachers.map(teacher => `
        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
          <div class="flex-1">
            <h4 class="font-medium text-gray-900">${teacher.name || teacher.username}</h4>
            <p class="text-sm text-gray-600">Subject: ${teacher.subject || 'Not specified'}</p>
            <p class="text-sm text-gray-600">Grade: ${teacher.grade || 'Not specified'}</p>
            <p class="text-sm text-gray-600">Advisory: ${teacher.advisory_section || 'None'}</p>
          </div>
          <button onclick="assignTeacher(${teacher.id}, '${teacher.name || teacher.username}')" 
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
            Assign
          </button>
        </div>
      `).join('');
    }

    function filterTeachers() {
      const gradeFilter = document.getElementById('filterGrade').value;
      const subjectFilter = document.getElementById('filterSubject').value;
      const nameFilter = document.getElementById('filterName').value.toLowerCase();

      filteredTeachers = allTeachers.filter(teacher => {
        const matchesGrade = !gradeFilter || teacher.grade === gradeFilter;
        const matchesSubject = !subjectFilter || teacher.subject === subjectFilter;
        const matchesName = !nameFilter || (teacher.name || teacher.username || '').toLowerCase().includes(nameFilter);
        
        return matchesGrade && matchesSubject && matchesName;
      });

      renderTeacherList();
    }

    function clearFilters() {
      document.getElementById('filterGrade').value = '';
      document.getElementById('filterSubject').value = '';
      document.getElementById('filterName').value = '';
      filteredTeachers = [...allTeachers];
      renderTeacherList();
    }

    async function assignTeacher(teacherId, teacherName) {
      // Get current teacher's advisory section
      const teacherUser = localStorage.getItem('teacherUser');
      if (!teacherUser) {
        alert('Authentication error. Please log in again.');
        return;
      }

      const teacher = JSON.parse(teacherUser);
      const advisorySection = teacher.advisory_section;

      if (!advisorySection) {
        alert('You do not have an advisory section assigned. Cannot assign subject teachers.');
        return;
      }

      if (!confirm(`Assign ${teacherName} as a subject teacher to your advisory section "${advisorySection}"?`)) {
        return;
      }

      try {
        const data = {
          admin_id: teacherId,
          section: advisorySection,
          role: 'subject_teacher'
        };

        const response = await fetch('/tms/remediation-web/api/add-teacher-section.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        
        if (result.success) {
          alert(`✅ ${teacherName} has been assigned as a subject teacher to section "${advisorySection}"!`);
          
          // Refresh both the main dashboard and modal
          loadAssignedTeachersOnDashboard();
          loadAssignedTeachersForModal().then(() => {
            loadAvailableTeachers(); // This will now exclude the newly assigned teacher
          });
        } else {
          alert('❌ ' + (result.error || 'Failed to assign teacher'));
        }
        
      } catch (error) {
        alert('❌ Server error occurred while assigning teacher');
      }
    }

    async function loadTeacherProfile() {
      try {
        // Get current teacher info from localStorage
        const teacherUser = localStorage.getItem('teacherUser');
        if (!teacherUser) {
          alert('Teacher authentication error. Please log in again.');
          window.location.href = 'teacher-login.html';
          return;
        }
        
        const teacher = JSON.parse(teacherUser);
        
        // Update the modal with teacher's advisory section info
        document.getElementById('profileAdvisorySection').textContent = teacher.advisory_section || 'Not assigned';
        document.getElementById('profileName').textContent = teacher.name || teacher.username;
        document.getElementById('profileSubject').textContent = teacher.subject || 'N/A';
        
      } catch (error) {
        alert('Error loading profile information');
      }
    }

    function openSectionManagement() {
      document.getElementById('sectionModal').classList.remove('hidden');
      loadTeacherProfile();
      
      // Load assigned teachers first, then available teachers
      loadAssignedTeachersForModal().then(() => {
        loadAvailableTeachers();
      });
    }

    async function loadAssignedTeachersForModal() {
      const teacher = checkTeacherAuth();
      if (!teacher || !teacher.advisory_section) return;

      try {
        const response = await fetch(`/tms/remediation-web/api/assigned-teachers.php?section=${encodeURIComponent(teacher.advisory_section)}`);
        const data = await response.json();

        if (data.success) {
          assignedTeachers = data.data || [];
        }
      } catch (error) {
        assignedTeachers = [];
      }
    }

    function closeSectionManagement() {
      document.getElementById('sectionModal').classList.add('hidden');
    }

    // Sections Taught Management Functions
    let gradeLevelsData = [];

    function openSectionsTaughtManagement() {
      document.getElementById('sectionsTaughtModal').classList.remove('hidden');
      loadCurrentSectionsTaught();
      loadGradeLevelsForSections();
    }

    function closeSectionsTaughtManagement() {
      document.getElementById('sectionsTaughtModal').classList.add('hidden');
    }

    async function loadGradeLevelsForSections() {
      try {
        const response = await fetch('/tms/remediation-web/api/grade-levels.php');
        const data = await response.json();
        
        if (data.success && Array.isArray(data.data)) {
          gradeLevelsData = data.data;
          
          // Populate grade levels AFTER data is loaded
          populateGradeLevelsForSections();
          
          // Add event listener for grade level changes
          const gradeSelect = document.getElementById('sectionGradeLevel');
          gradeSelect.removeEventListener('change', handleSectionGradeChange);
          gradeSelect.addEventListener('change', handleSectionGradeChange);
        } else {
          document.getElementById('sectionGradeLevel').innerHTML = '<option value="">Error loading grade levels</option>';
        }
      } catch (error) {
        document.getElementById('sectionGradeLevel').innerHTML = '<option value="">Error loading grade levels</option>';
      }
    }

    function populateGradeLevelsForSections() {
      const gradeSelect = document.getElementById('sectionGradeLevel');
      const teacher = checkTeacherAuth();
      
      // Check if grade levels data is loaded
      if (!gradeLevelsData || gradeLevelsData.length === 0) {
        gradeSelect.innerHTML = '<option value="">Loading grade levels...</option>';
        return;
      }
      
      // Clear existing options
      gradeSelect.innerHTML = '<option value="">Select grade level</option>';
      
      // Show all grade levels - teachers can choose any grade
      gradeLevelsData.forEach(grade => {
        const option = document.createElement('option');
        option.value = grade.level;
        option.textContent = `Grade ${grade.level}`;
        gradeSelect.appendChild(option);
      });
      
      // Pre-select teacher's grade if available
      if (teacher && teacher.grade) {
        gradeSelect.value = teacher.grade;
        loadAvailableSectionsForGrade(teacher.grade);
      }
    }

    function handleSectionGradeChange() {
      const gradeLevel = document.getElementById('sectionGradeLevel').value;
      loadAvailableSectionsForGrade(gradeLevel);
    }

    function loadAvailableSectionsForGrade(gradeLevel) {
      const sectionsSelect = document.getElementById('availableSections');
      
      // Clear existing sections
      sectionsSelect.innerHTML = '<option value="">Select a section</option>';
      
      if (!gradeLevel) {
        sectionsSelect.innerHTML = '<option value="">Select grade level first</option>';
        return;
      }
      
      // Find the grade data
      const gradeData = gradeLevelsData.find(g => g.level == gradeLevel);
      
      if (gradeData && gradeData.sections && gradeData.sections.length > 0) {
        gradeData.sections.forEach(section => {
          const option = document.createElement('option');
          option.value = `${gradeLevel}-${section.name}`;
          option.textContent = `${gradeLevel}-${section.name}`;
          sectionsSelect.appendChild(option);
        });
      } else {
        // No sections available for this grade
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No sections available for this grade';
        option.disabled = true;
        sectionsSelect.appendChild(option);
      }
    }

    async function loadCurrentSectionsTaught() {
      try {
        const teacher = checkTeacherAuth();
        if (!teacher) return;

        const currentSectionsList = document.getElementById('currentSectionsList');
        const sectionsString = teacher.sections || '';
        
        if (sectionsString.trim()) {
          const sections = sectionsString.split(',').map(s => s.trim()).filter(s => s);
          
          if (sections.length > 0) {
            currentSectionsList.innerHTML = sections.map(section => `
              <div class="flex justify-between items-center p-3 bg-white border border-gray-200 rounded-lg">
                <span class="font-medium text-gray-800">${section}</span>
                <button onclick="removeSection('${section}')" class="text-red-600 hover:text-red-800 text-sm font-medium">
                  Remove
                </button>
              </div>
            `).join('');
          } else {
            currentSectionsList.innerHTML = '<p class="text-gray-500 text-center py-8">No sections assigned yet</p>';
          }
        } else {
          currentSectionsList.innerHTML = '<p class="text-gray-500 text-center py-8">No sections assigned yet</p>';
        }
      } catch (error) {
        document.getElementById('currentSectionsList').innerHTML = '<p class="text-red-500 text-center py-8">Error loading sections</p>';
      }
    }

    async function addNewSection() {
      const sectionsSelect = document.getElementById('availableSections');
      const newSection = sectionsSelect.value.trim();
      
      if (!newSection) {
        alert('Please select a section to add');
        return;
      }

      try {
        const teacher = checkTeacherAuth();
        if (!teacher) return;

        // Get current sections
        const currentSections = teacher.sections ? teacher.sections.split(',').map(s => s.trim()) : [];
        
        // Check if section already exists
        if (currentSections.includes(newSection)) {
          alert('This section is already in your list');
          return;
        }

        // Add new section
        currentSections.push(newSection);
        const updatedSections = currentSections.join(', ');

        // Update teacher data in database
        const response = await fetch('/tms/remediation-web/api/update-teacher-sections.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            teacher_id: teacher.id,
            sections: updatedSections 
          })
        });

        const result = await response.json();
        
        if (result.success) {
          // Update localStorage
          teacher.sections = updatedSections;
          localStorage.setItem('teacherUser', JSON.stringify(teacher));
          
          // Reset dropdowns and reload list
          document.getElementById('sectionGradeLevel').value = '';
          document.getElementById('availableSections').innerHTML = '<option value="">Select grade level first</option>';
          loadCurrentSectionsTaught();
          
          alert('✅ Section added successfully!');
        } else {
          alert('❌ Failed to add section: ' + (result.error || 'Unknown error'));
        }
        
      } catch (error) {
        alert('❌ Server error occurred');
      }
    }

    async function removeSection(sectionToRemove) {
      if (!confirm(`Remove section "${sectionToRemove}" from your taught sections?`)) {
        return;
      }

      try {
        const teacher = checkTeacherAuth();
        if (!teacher) return;

        // Get current sections and remove the specified one
        const currentSections = teacher.sections ? teacher.sections.split(',').map(s => s.trim()) : [];
        const updatedSections = currentSections.filter(s => s !== sectionToRemove);
        const updatedSectionsString = updatedSections.join(', ');

        // Update teacher data in database
        const response = await fetch('/tms/remediation-web/api/update-teacher-sections.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            teacher_id: teacher.id,
            sections: updatedSectionsString 
          })
        });

        const result = await response.json();
        
        if (result.success) {
          // Update localStorage
          teacher.sections = updatedSectionsString;
          localStorage.setItem('teacherUser', JSON.stringify(teacher));
          
          // Reload list
          loadCurrentSectionsTaught();
          
          alert('✅ Section removed successfully!');
        } else {
          alert('❌ Failed to remove section: ' + (result.error || 'Unknown error'));
        }
        
      } catch (error) {
        alert('❌ Server error occurred');
      }
    }

    // Check teacher authentication
    function checkTeacherAuth() {
      const teacherLoggedIn = localStorage.getItem("teacherLoggedIn");
      const teacherToken = localStorage.getItem("teacherToken");
      const teacherUser = localStorage.getItem("teacherUser");
      
      if (teacherLoggedIn !== "true" || !teacherToken || !teacherUser) {
        alert("Access denied. Please log in as a teacher.");
        window.location.href = "teacher-login.html";
        return false;
      }
      
      try {
        const teacher = JSON.parse(teacherUser);
        // Update UI with teacher info
        const teacherNameElement = document.getElementById('teacherName');
        if (teacherNameElement) {
          teacherNameElement.textContent = teacher.name || teacher.username || 'Teacher';
        }
        return teacher; // Return the teacher object, not just true
      } catch (error) {
        localStorage.removeItem("teacherLoggedIn");
        localStorage.removeItem("teacherToken");
        localStorage.removeItem("teacherUser");
        window.location.href = "teacher-login.html";
        return false;
      }
    }

    // Assigned Teachers Management Functions
    let assignedTeachers = [];

    async function loadAssignedTeachersOnDashboard() {
      const teacher = checkTeacherAuth();
      if (!teacher || !teacher.advisory_section) {
        // Hide the section if teacher is not an adviser
        document.getElementById('assignedTeachersSection').style.display = 'none';
        return;
      }

      // Show the section and update advisory info
      document.getElementById('assignedTeachersSection').style.display = 'block';
      document.getElementById('currentAdvisorySection').textContent = teacher.advisory_section;

      try {
        const response = await fetch(`/tms/remediation-web/api/assigned-teachers.php?section=${encodeURIComponent(teacher.advisory_section)}`);
        const data = await response.json();

        if (data.success) {
          assignedTeachers = data.data || [];
          renderAssignedTeachers();
        } else {
          document.getElementById('assignedTeachersList').innerHTML = `<p class="text-red-500">Error: ${data.message}</p>`;
        }
      } catch (error) {
        document.getElementById('assignedTeachersList').innerHTML = '<p class="text-red-500">Error loading assigned teachers</p>';
      }
    }

    function renderAssignedTeachers() {
      const list = document.getElementById('assignedTeachersList');
      
      if (assignedTeachers.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-center py-4">No subject teachers assigned yet. Use the "Assign Subject Teachers" button to add teachers.</p>';
        return;
      }

      list.innerHTML = assignedTeachers.map(teacher => `
        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
          <div class="flex-1">
            <h4 class="font-medium text-gray-900">${teacher.name || teacher.username}</h4>
            <p class="text-sm text-gray-600">Subject: ${teacher.subject || 'Not specified'}</p>
            <p class="text-sm text-gray-600">Grade Level: ${teacher.grade || 'Not specified'}</p>
            <p class="text-xs text-gray-500">Assigned: ${new Date(teacher.assigned_at).toLocaleDateString()}</p>
          </div>
          <button onclick="removeAssignedTeacher(${teacher.id}, '${teacher.name || teacher.username}')" 
                  class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
            Remove
          </button>
        </div>
      `).join('');
    }

    async function removeAssignedTeacher(teacherId, teacherName) {
      const teacher = checkTeacherAuth();
      if (!teacher || !teacher.advisory_section) return;

      if (!confirm(`Remove ${teacherName} from your advisory section "${teacher.advisory_section}"?`)) {
        return;
      }

      try {
        const response = await fetch('/tms/remediation-web/api/assigned-teachers.php', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            teacher_id: teacherId,
            section: teacher.advisory_section
          })
        });

        const result = await response.json();
        
        if (result.success) {
          alert('✅ Teacher removed successfully!');
          loadAssignedTeachersOnDashboard(); // Refresh the list
        } else {
          alert('❌ Failed to remove teacher: ' + (result.message || 'Unknown error'));
        }
      } catch (error) {
        alert('❌ Server error occurred');
      }
    }

    function refreshAssignedTeachers() {
      loadAssignedTeachersOnDashboard();
    }

    const teacherData = checkTeacherAuth();
    if (teacherData) {
      fetchStudents();
      loadModules();
      loadAssignedTeachersOnDashboard(); // Load assigned teachers
    }
  </script>
</body>
</html>
