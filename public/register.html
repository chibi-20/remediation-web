
<!DOCTYPE html>
<html lang="tl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register Student</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card-shadow {
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="gradient-bg shadow-lg">
    <div class="max-w-xl mx-auto px-4 py-6 flex justify-center items-center">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
          <span class="text-2xl">üìù</span>
        </div>
        <div>
          <h1 class="text-xl font-bold text-white">Student Registration</h1>
        </div>
      </div>
    </div>
  </header>
  <main class="max-w-md mx-auto mt-10 p-8 bg-white rounded-xl card-shadow">
    <h2 class="text-2xl font-bold text-blue-700 mb-6 text-center">Create Student Account</h2>
    <form id="registerForm" class="space-y-5">
      <div>
        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
        <input type="text" id="lastName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
      </div>
      <div>
        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
        <input type="text" id="firstName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
      </div>
      <div>
        <label for="middleInitial" class="block text-sm font-medium text-gray-700 mb-1">Middle Initial</label>
        <input type="text" id="middleInitial" maxlength="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>
      <div>
        <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">Grade Level</label>
        <select id="grade" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          <option value="">-- Select Grade Level --</option>
        </select>
      </div>
      <div>
        <label for="admin" class="block text-sm font-medium text-gray-700 mb-1">Teacher</label>
        <select id="admin" name="adminId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          <option value="">-- Select Teacher --</option>
        </select>
        <p class="text-xs text-gray-500 mt-1">Teachers are filtered by selected grade level</p>
      </div>
      <div>
        <label for="lrn" class="block text-sm font-medium text-gray-700 mb-1">LRN</label>
        <input type="text" id="lrn" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
      </div>
      <div>
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required minlength="6" autocomplete="new-password">
      </div>
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition-colors duration-200">Register</button>
    </form>
    <div id="message" class="mt-4 text-center text-red-500"></div>
    <div class="flex justify-between mt-6">
      <a href="login.html" class="text-blue-600 hover:underline">‚Üê Back to Login</a>
    </div>
  </main>
  <script>
    let teachersData = [];

    // Load grades when page loads
    document.addEventListener('DOMContentLoaded', function() {
      fetch('/tms/remediation-web/api/public-grades.php')
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          const gradeSelect = document.getElementById('grade');
          if (data && data.length > 0) {
            data.forEach(gradeObj => {
              const option = document.createElement('option');
              option.value = gradeObj.grade;
              option.textContent = `Grade ${gradeObj.grade}`;
              gradeSelect.appendChild(option);
            });
          } else {
          }
        })
        .catch(err => {
          alert('Failed to load grade levels. Please refresh the page.');
        });
    });

    // Handle grade selection to load teachers
    document.getElementById('grade').addEventListener('change', function() {
      const selectedGrade = this.value;
      const teacherSelect = document.getElementById('admin');
      teacherSelect.innerHTML = '<option value="">-- Select Teacher --</option>';
      
      if (selectedGrade) {
        fetch(`/tms/remediation-web/api/teachers-by-grade.php?grade=${selectedGrade}`)
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then(response => {
            if (response.success && response.data) {
              teachersData = response.data;
              if (response.data && response.data.length > 0) {
                response.data.forEach(teacher => {
                  const option = document.createElement('option');
                  option.value = teacher.id;
                  option.textContent = `${teacher.name} - ${teacher.advisory_section}`;
                  teacherSelect.appendChild(option);
                });
              } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No teachers available for this grade';
                option.disabled = true;
                teacherSelect.appendChild(option);
              }
            } else {
              const option = document.createElement('option');
              option.value = '';
              option.textContent = response.message || 'Error loading teachers';
              option.disabled = true;
              teacherSelect.appendChild(option);
            }
          })
          .catch(err => {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Error loading teachers';
            option.disabled = true;
            teacherSelect.appendChild(option);
          });
      }
    });

    document.getElementById('registerForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      // Get the selected teacher's advisory section
      const selectedTeacherId = document.getElementById('admin').value;
      const selectedTeacher = teachersData.find(t => t.id == selectedTeacherId);
      const section = selectedTeacher ? selectedTeacher.advisory_section : '';
      
      const data = {
        lastName: document.getElementById('lastName').value.trim(),
        firstName: document.getElementById('firstName').value.trim(),
        middleInitial: document.getElementById('middleInitial').value.trim(),
        grade: document.getElementById('grade').value.trim(),
        section: section,
        lrn: document.getElementById('lrn').value.trim(),
        password: document.getElementById('password').value,
        adminId: document.getElementById('admin').value
      };
      
      const msg = document.getElementById('message');
      msg.className = '';
      msg.textContent = '';
      
      try {
        const res = await fetch('/tms/remediation-web/api/register-student.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          msg.textContent = '‚úÖ ' + (result.message || 'Student registered successfully!');
          msg.className = 'success';
          document.getElementById('registerForm').reset();
          // Reset teacher dropdown
          document.getElementById('admin').innerHTML = '<option value="">-- Select Teacher --</option>';
        } else {
          msg.textContent = '‚ùå ' + (result.message || 'Registration failed.');
          msg.className = 'error';
        }
      } catch (err) {
        msg.textContent = '‚ùå Server error.';
        msg.className = 'error';
      }
    });
  </script>
</body>
</html>
